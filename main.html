
<html>
<head> 
  <meta charset="UTF-8">
  <link href="css/main.css" rel="stylesheet" />
  <link href="css/bootstrap.css" rel="stylesheet"/>
  <link href='https://fonts.googleapis.com/css?family=Poppins:400,700' rel='stylesheet' type='text/css'>
  <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="js/main.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>

</head>
<body>
  <nav class="navbar navbar-inverse">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">MedManager</a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">

          <!-- not a visible link because this is sort of a cheat so that we can get the alert -->
          <p class="navbar-text" id="currentTime" href="#">Current Time: 6:30AM</p>
          <p class="navbar-text">Signed in as: Katrina</p>
          <li><a href="index.html" id="login">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <table class="table table-striped table-hover" id="patientTable">
    <tr class="first-row"> 
      <th>Delivery Time</th>
      <th>Patient</th>
      <th>Room Number</th>
      <th>Medication</th>
      <th style="text-align:left;">Delivered?</th>
    </tr>

    <tr>
      <td>07:00AM</td>
      <td>Sharon Lastname </br><a  href="sharon_lastname.html" type="button" class="btn btn-primary">View/Edit Patient Info</a></td>
      <td>503</td>
      <td>Rivaroxaban</br> <span style="font-style: italic;">200mg</span></td>
      <td > 
        <div id="errorMessage1" style="color: red; display: none; padding-bottom: 10px; font-size: 10;">Incorrect dosage </div> 
        <form id ="dosageForm">
          <input type="dosage" class="form-control" id="dosageConfirm1" placeholder="Dosage Delivered" style="width: 55%; font-size: 12;">
           <button type="submit" class="btn btn-success" id="confirm1">Confirm</button>
           <input type="checkbox" class="deliveredBox" id="box1" style= "display: none;">
         </form>
       </td>
    </tr>
    
    <tr>
      <td>07:30AM</td>
      <td>Ben Bitdiddle </br><a href="ben_bitdiddle.html" type="button" class="btn btn-primary">View/Edit Patient Info</a></td>
      <td>621</td>
      <td>MedicationB </br><span style="font-style: italic;">400mg</span></td>
      <td >
        <div id="errorMessage2" style="color: red; display: none; padding-bottom: 10px; font-size: 10;">Incorrect dosage</div>
        <form class="dosageForm">
          <input type="dosage" class="form-control" id="dosageConfirm2" placeholder="Dosage Delivered" required style="width: 55%; font-size: 12;">
          <button type="submit" class="btn btn-success" id="confirm2">Confirm</button><input type="checkbox" class="deliveredBox" id="box2" style = "display: none;"> 
        </form>
      </td>
    </tr>
    
    <tr>
      <td>08:00AM</td>
      <td>Pablo Sanchez </br><button type="button" class="btn btn-primary">View/Edit Patient Info</button></td>
      <td>404</td>
      <td>MedicationC </br><span style="font-style: italic;">300mg</span></td>
      <td > 
        <div id="errorMessage3" style="color: red; display: none; padding-bottom: 10px; font-size: 10;">Incorrect dosage</div>
        <form class="dosageForm">
          <input type="dosage" class="form-control" id="dosageConfirm3" placeholder="Dosage Delivered" style="width: 55%; font-size: 12;"></div>
          <button type="submit" class="btn btn-success" id="confirm3">Confirm</button><input type="checkbox" class="deliveredBox" id="box3" style = "display: none;">
        </form>
      </td>
    </tr>
  </table>

  <nav class="navbar navbar-default navbar-fixed-bottom">
    <div class="container">
      <a href="newpatient.html" type="button" class="btn btn-default navbar-btn" style="height: 40px; font-size: 18; vertical-align: middle;">+ Add New Patient</a>
    </div>
  </nav>

  <!-- change time alert -->
  <div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" style="margin-top: 11%; ">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header" style="  color: #a94442; background-color: #f2dede; border-color: #ebccd1;">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel">Alert</h4>
        </div>
        <div class="modal-body">
          <p id = "modalText" style="font-size: 16; text-align: center;"><b>Reminder:</b> You have ten minutes to deliver<!-- <span style="color: #990000;">Rivaroxaban</span> to <span style="color: #990000;">Sharon Lastname</span>. --></p>
        </div>
        <div class="modal-footer">
          <button type="button" autofocus class="btn btn-primary" data-dismiss="modal" style="width: 20%; font-size: 16; background-color: #a94442; border-color: #ebccd1;">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- changing checkbox alert -->
  <div class="modal fade" id="deliveredModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" style="margin-top: 11%;">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel">Confirmation</h4>
        </div>
        <form id="checkboxConfirmation" class="form-signin">
          <div class="modal-body">
            <p>Enter password to confirm action:</p>
            <div id="errorMessage" style="color: red; display: none; padding-bottom: 10px;">Invalid password</div>
            <input type="password" id="password" class="form-control" placeholder="Password" required autofocus>
          </div>
          <div class="modal-footer">
            <button id="submitPassword" class="btn btn-primary" type="submit" name="submit" style="width: 20%; font-size: 16;">Confirm</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" onClick="refreshPage()" style="width: 20%; font-size: 16;">Cancel</button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <script type="text/javascript">
    // changes time so that the alert shows up
    $(document).ready(function (e) {
      // $('#currentTime').click(function(evt) {
      //   document.getElementById('currentTime').innerHTML = 'Current Time: 6:55AM';
      //    $('#alertModal').modal('show');
      // });
      window.setInterval(setTime(), 3000);

      // resets at logout for testing
      $('#login').click(function (evt) {
        localStorage.setItem("newPatient", "false");
        var checkboxes = document.getElementsByClassName("deliveredBox");
        for (var i = 0; i < checkboxes.length; i++) {
          var boxID = checkboxes[i].id.toString();
          localStorage.setItem(boxID, "false");
        }
      });

      // $('input').on('change', function() {
      //   var checkbox = this;
      //   // $('#deliveredModal').modal('show');
      //   // $('#deliveredModal').on('shown.bs.modal', function () {
      //   //   $('#password').focus();
      // });

      // $('#deliveredModal').on('hidden.bs.modal', function (evt) {
      //   // console.log("revert back the checkbox status");

      // });

      function submitButtonHandler(evt){
        this.removeEventListener('click', submitButtonHandler);
        var valid = true;
        if (document.getElementById('password').value != "med") {
          valid = false;
        }
        if (!valid) {
          $('#errorMessage').show();
          evt.preventDefault();
        } else {
          localStorage.setItem(checkbox.id.toString(), $(checkbox).is(':checked'));
          sortTable();
        }
      }

      function confirmationButtonHandler(evt){
        var valid = true;
        var button = document.getElementById(evt.target.id);
        var rowIndex = button.parentNode.parentNode.parentNode.rowIndex;
        var table = document.getElementById('patientTable');
        var meds = table.rows[rowIndex].cells[3].textContent.split(' ')[1];
        var form = table.rows[rowIndex].cells[4].children[1].children[0];
        var errormessage = table.rows[rowIndex].cells[4].children[0].id;
        var checkbox = table.rows[rowIndex].cells[4].children[1].children[2]
        console.log(checkbox);
        meds = meds.substring(0, meds.length - 2);
  
        if (form.value != meds){
          valid = false;
        }

        if (!valid){
          evt.preventDefault();
          console.log(valid)
          $('#'+errormessage).show();
          evt.preventDefault();
          form.style.borderColor = 'red';
        }

        else{
          $('#'+errormessage).hide();
          localStorage.setItem(checkbox.id.toString(), "true");
          $(checkbox).is(":checked");
          console.log(localStorage.getItem(checkbox.id.toString()) == 'true');
          sortTable();
          evt.preventDefault();
          form.style.backgroundColor = '#80ffaa';
          form.style.borderColor = '#80ffaa';
          form.disabled = 'disabled';
          button.disabled= 'disabled';
        }
        
      }
        // var submitButton = document.getElementById('checkboxConfirmation');
        var submitButton = document.getElementById('submitPassword');
        submitButton.addEventListener('click', submitButtonHandler);
        var confirmButton = document.getElementById('confirm1');
        confirmButton.addEventListener('click', confirmationButtonHandler);
        var confirmButton2 = document.getElementById('confirm2');
        confirmButton2.addEventListener('click', confirmationButtonHandler);
        var confirmButton3 = document.getElementById('confirm3');
        confirmButton3.addEventListener('click', confirmationButtonHandler);


        // $('submitPassword').click(function(evt){
        //   var valid = true;
        //   if (document.getElementById('password').value != "med") {
        //     valid = false;
        //   }
        //   if (!valid) {
        //       $('#errorMessage').show();
        //       evt.preventDefault();
        //   } else {
        //     localStorage.setItem(checkbox.id.toString(), $(checkbox).is(':checked'));
        //     sortTable();
        //   }
        // });



        // cancel does not change localStorage but changes temporary look, 
        // this does not work
        $("#cancelPassword").on("click", function (evt) {
          console.log("cancel");
        });



      });

    // creates new table row with the added patient's information
    var newPatient = localStorage.newPatient;
    if (newPatient == "true") {
      var row = document.getElementById("patientTable").insertRow(-1);
      row.innerHTML = '<tr><td>07:30AM</td><td>Mary Jones</br><a  href="created_patient.html" type="button" class="btn btn-primary">View/Edit Patient Info</a></td><td>211</td><td>Medication X </br> 2 tablets</td><td style="text-align:center; vertical-align: middle;"><input type="checkbox" class="deliveredBox" id="box4"></td></tr>';
      // should be based on actual inputs
    }

    function refreshPage(){
      window.location.reload();
    } 

    $(function(){
      var checkboxes = document.getElementsByClassName("deliveredBox");
      for (var i = 0; i < checkboxes.length; i++) {
        var boxID = checkboxes[i].id.toString();
        var test = localStorage.getItem(boxID) === 'true'? true: false;
        $(checkboxes[i]).prop('checked', test || false);
      }
    });

    function sortTable(){ // should also sort relative to current time
      var tbl = document.getElementById("patientTable").tBodies[0];
      var store = [];
      for(var i=1, len=tbl.rows.length; i<len; i++){ //start at row one to preserve header
        var row = tbl.rows[i];
        var checkbox = document.getElementsByClassName("deliveredBox")[i-1];

        if (localStorage.getItem(checkbox.id.toString()) == 'true') {
          var sortnr = 25;
        } else {
          var stringTime = row.cells[0].textContent;
          var plusTwelve = stringTime.substring(stringTime.length-2);

          stringTime = stringTime.substring(0, stringTime.length-2);
          var splitTime = stringTime.replace(/(^:)|(:$)/g, '').split(":");
          splitTime[0] = parseInt(splitTime[0]);

          if (plusTwelve == "PM"){
            splitTime[0] += 12;
          }
          var sortnr = splitTime[0] + parseInt(splitTime[1]) / 60;
        }

        if(!isNaN(sortnr)) store.push([sortnr, row]);
      }
      store.sort(function(x,y){
        console.log("x: " + x[0]);
        console.log("y: " + y[0]);
        return x[0] - y[0];
      });
      for(var i=0, len=store.length; i<len; i++){
        tbl.appendChild(store[i][1]);
      }
      store = null;
    }
    sortTable();

    function deliveryAlert(){
      var tbl = document.getElementById("patientTable").tBodies[0];
      var deliveryRows = [1];
      var firstRow = tbl.rows[1];
      var firstDelivery = firstRow.cells[0].textContent;
      var hours = parseInt(firstDelivery.substring(0, 2));
      var minutes = parseInt(firstDelivery.substring(3, firstDelivery.length - 2)) - 10;
      if (minutes < 0) {
        minutes = 60 + minutes;
        hours -= 1;
      }
      hours = String(hours);
      minutes = String(minutes);

      if(firstDelivery.substring(firstDelivery.length-2) == "PM") { //change to pm 
        hours = parseInt(hours) + 12;
        hours = hours.toString();
      } 

      if (hours.length == 1){
        hours = "0" + hours;
      }

      var delivery = hours + ":" + minutes;

      for(var i=2, len=tbl.rows.length; i<len; i++){ //start at row one to preserve header
        var row = tbl.rows[i];
        var deliveryTime = row.cells[0].textContent;
        if (deliveryTime == firstDelivery) {
          deliveryRows.push(i);
        }
      }

      var currentTime = getTime();

      //delivery = currentTime;
      if (currentTime == delivery) {
        var alert = document.getElementById('alertModal');
        var text = document.getElementById('modalText');
        var modalStart = '<p id = "modalText" style="font-size: 16; text-align: left;"><b>Reminder:</b> You have ten minutes to deliver:';
        var modalEnd = '</p>';
        var modalInner = '<span style="color: #990000;">';
        var modalMiddle = '';
        for (var i = 0; i < deliveryRows.length; i++) {
          var name = tbl.rows[deliveryRows[i]].cells[1].textContent;
          var med = tbl.rows[deliveryRows[i]].cells[3].textContent.split(' ')[0];

          modalMiddle += "<p style='text-align: center'>" + modalInner + med + "</span> to " + modalInner + name.substring(0, name.length - 22) + "</span></p>" ;
        }
        text.innerHTML = modalStart + modalMiddle + modalEnd;
        $('#alertModal').modal('show');
      }
    }
    deliveryAlert();

    function getTime() {

      var today = new Date();
      var h = ('0'+today.getHours()).slice(-2);
      var m = ('0'+today.getMinutes()).slice(-2);
      var now = h+":"+m;

      return now;
    }

    function setTime() {
      var currentTime = getTime();
      if (parseInt(currentTime.substring(0, 2)) > 12) {
        currentTime = String(parseInt(currentTime.substring(0, 2)) - 12) + currentTime.substring(2) + "PM";
      } else {
        currentTime += "AM";
      }
      document.getElementById('currentTime').innerHTML = 'Current Time: ' + currentTime;
      var t = setTimeout(setTime, 3000);
    }
    setTime();

    </script>

  </body>

  </html>

